generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  avatarData    Bytes?   @db.LongBlob
  avatarMime    String?  @db.VarChar(100)
  subjects      Json?    
  bio           String?  @db.Text
  city          String?
  experience    Int?
  pricePerHour  Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ads           Ad[]
  messages Message[]
  conversationParticipants ConversationParticipant[]

  @@map("users")
}

model Ad{
  id            String   @id @default(cuid())
  userId        String 
  user          User     @relation(fields:[userId],references:[id], onDelete:Cascade)

  type          String
  subject       String
  areas         Json
  level         String
  pricePerHour  Int?
  location      String
  city          String?
  description   String   @db.Text 

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt DateTime?
  isActive Boolean @default(true)

  @@map("ads")
  @@index([deletedAt])

}

model Conversation{
  id String @id @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  
  messages Message[]

  @@map("conversations")
}

model ConversationParticipant{
  id String @id @default(cuid())
  userId String
  conversationId String

  isArchived Boolean @default(false)
  archivedAt DateTime?

  user User @relation(fields:[userId],references:[id], onDelete:Cascade)
  conversation Conversation @relation(fields:[conversationId],references:[id],onDelete:Cascade)

  @@unique([userId,conversationId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message{
  id String @id @default(cuid())

  content String @db.Text
  createdAt DateTime @default(now())
  isRead Boolean @default(false)
  isEdited Boolean @default(false)
  editedAt DateTime?
  isDeleted Boolean @default(false)
  deletedAt DateTime?

  conversationId String
  senderId String

  conversation Conversation @relation(fields:[conversationId],references:[id],onDelete: Cascade)
  sender User @relation(fields:[senderId],references:[id],onDelete:Cascade)


  @@map("messages")
  @@index([conversationId,isRead,isDeleted])
  @@index([senderId])
  @@index([createdAt])
}